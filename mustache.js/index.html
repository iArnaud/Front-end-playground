<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Mustache.js show-off</title>
        <style>
            #map {
                height: 400px;
                width: 800px;
            }
            h1,p,span {
               font-family: 'Noto Sans', sans-serif;
               font-weight: normal;
               color: #444;
           }
        </style>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
        <!--[if lte IE 8]>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
        <![endif]-->
        <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
        <!-- locally: <script src="../js/leaflet.js"></script>-->

    </head>
    <body>

        <h1>Live earthquakes around Nantes, France</h1>
        <p id="legend"></p>
        <div id="map"></div>
    </body>
    <script src="../js/jquery-1.9.1.min.js"></script>
    <script>
        "use strict";
        var map, basemap = null;
        var defaultZoom = 7;
        var origin = [47, -2];
        var shakes = [];
        var markers = [];
        var attribution = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ';
        attribution += '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ';
        attribution += 'Imagery © <a href="http://cloudmade.com">CloudMade</a> - ';
        attribution += 'Earthquakes RSS feed from © <a href="http://emsc-csem.org">emsc-csem.org</a>';
        var apiKey = '4c84f836ade24ee5af7c98fcf67b0f2b';


        var initialize = function () {
            map = L.map('map').setView(origin, defaultZoom);
            basemap = L.tileLayer('http://{s}.tile.cloudmade.com/' + apiKey + '/1/256/{z}/{x}/{y}.png',
            {
                maxZoom:19
            }).addTo(map);
            L.tileLayer('http://{s}.tile.cloudmade.com/' + apiKey + '/997/256/{z}/{x}/{y}.png', {
                attribution: attribution,
                maxZoom: 18
            }).addTo(map);
        }

        $.fn.filterNode = function(name) {
            return this.find('*').filter(function() {
                return this.nodeName === name;
            });
        };


        function xmlToJson(xml) {

            // Create the return object
            var obj = {};

            // text node
            if (4 === xml.nodeType) {
                obj = xml.nodeValue;
            }

            if (xml.hasChildNodes()) {
                for (var i = 0; i < xml.childNodes.length; i++) {
                    var TEXT_NODE_TYPE_NAME = '#text',
                    item = xml.childNodes.item(i),
                    nodeName = item.nodeName,
                    content;

                    if (TEXT_NODE_TYPE_NAME === nodeName) {
                        //single textNode or next sibling has a different name
                        if ((null === xml.nextSibling) || (xml.localName !== xml.nextSibling.localName)) {
                            content = xml.textContent;

                            //we have a sibling with the same name
                            } else if (xml.localName === xml.nextSibling.localName) {
                            //if it is the first node of its parents childNodes, send it back as an array
                            content = (xml.parentElement.childNodes[0] === xml) ? [xml.textContent] : xml.textContent;
                        }
                        return content;
                        } else {
                        if ('undefined' === typeof(obj[nodeName])) {
                            obj[nodeName] = xmlToJson(item);
                            } else {
                            if ('undefined' === typeof(obj[nodeName].length)) {
                                var old = obj[nodeName];
                                obj[nodeName] = [];
                                obj[nodeName].push(old);
                            }

                            obj[nodeName].push(xmlToJson(item));
                        }
                    }
                }
            }
            return obj;
        }

        var Shake = function (args) {
            this.geo = args.json;

            this.lat = parseFloat(this.geo['geo:lat']);
            this.long = parseFloat(this.geo['geo:long']);
            this.latLng = new L.LatLng(this.lat, this.long);
            this.magnitude = this.magnitude || parseFloat(this.geo['emsc:magnitude'].replace('ML ',''));
            this.depth = parseInt($.trim(this.geo['emsc:depth']));
            this.time = this.geo['emsc:time'];
            this.year =  parseInt(this.time.substring(0,4));
            this.month = parseInt(this.time.substring(5,7));
            this.yearMonth = this.time.substring(0,7);
            this.popUpContent = '<span>' + this.geo['title'];
            this.popUpContent += '<br>' + this.time;
            this.popUpContent += "<br>" + this.magnitude;
            this.popUpContent += "<br>" + this.depth;
            this.popUpContent += "<br>" + this.lat + ";" + this.long;
            this.popUpContent += "<br><a href='" + this.link + "'>link</a>";
            this.popUpContent += '</span>';
            shakes.push(this);
            this.placeMarker = function (){
                var marker = L.marker(this.latLng).addTo(map);
                marker.bindPopup(this.popUpContent);
                markers.push(marker);
            }
        };

        var Stats = function() {};
        Stats.prototype = {
            Richters_min : 0,
            Richters_max : 12,
            Richters_step : 1,
            Richters_levels : [],
            Richters_knownLevels : {},

            Richters_depths : [],
            Richters_knownDepths : {},

            Richters_knownYears : [],
            Richters_knownMonthes : [],

            statsLegend : "",

            Register : function(shake) {
                var i = 0;
                for(i=this.Richters_min;i<this.Richters_max;i+=this.Richters_step) {
                    this.Richters_levels[i] = this.Richters_levels[i] || [];
                    if((i <= shake.magnitude) && (shake.magnitude < parseFloat(i+this.Richters_step))) {
                        this.Richters_levels[i].push(shake);
                    }
                }
            },

            GenerateShakesStats : function(currentMonth) {
                var i=0;
                var shakesLevels = [];
                var shakesYears = [];
                this.statsLegend = "";


                if (6 === currentMonth.length) {
                    currentMonth = currentMonth.substring(0,5) + "0" + currentMonth.substring(5,1);
                }
                currentMonth = currentMonth.substring(4,2) + '/' + currentMonth.substring(0,4);

                // levels
                for(i=this.Richters_min;i<this.Richters_max;i+=this.Richters_step) {
                    if(this.Richters_levels[i] && 0 < this.Richters_levels[i].length) {
                        this.Richters_knownLevels[""+i] = this.Richters_levels[i];
                    }
                }
                for(i=0;i<shakes.length;i++) {
                    if(2000 < shakes[i].year) {
                        this.Richters_knownYears[shakes[i].year+""] = this.Richters_knownYears[shakes[i].year+""] || 0;
                        this.Richters_knownYears[shakes[i].year+""] += 1;
                    }
                    // TODO : add stats for current month
                }
                i=0;
                for(var prop in this.Richters_knownLevels){
                    shakesLevels.push(this.Richters_knownLevels[prop].length + " shakes with magnitude " + (i+1));
                    i++;
                }
                this.statsLegend = shakesLevels.join(' ; ') + '.';


                // years
                for(var prop in this.Richters_knownYears) {
                    shakesYears.push(this.Richters_knownYears[prop] + " shakes in " + prop );
                }
                this.statsLegend += '<br />' + shakesYears.join(' ; ');
                //this.statsLegend += ' in ' + currentMonth + '.';
            }
        };

        function handleRSS(url) {
            $.ajax({
                type: "GET",
                url: url,
                dataType: 'xml'
            }).done(function(xml) {
                var i=0;
                var date = new Date();
                var currentMonth = date.getFullYear() + '_' + parseInt(date.getMonth()+1);
                var stats= new Stats();
                $(xml).filterNode('item').each(function() {
                    var shake = new Shake({json: xmlToJson(this)});
                    shake.placeMarker();
                    stats.Register(shake);
                });
                var legend = '<a href="'+url+'">Earthquakes feed source</a>';
                legend += ' - ' + shakes.length + ' earthquakes';
                if(shakes.length > 0) {
                    legend += ' from ' + shakes[shakes.length-1]['emsc:time'] + ' to ' + shakes[0]['emsc:time'];
                }
                stats.GenerateShakesStats(currentMonth);
                legend += ":<br />" + stats.statsLegend;
                $('#legend').html(legend);
            });
        }

        $(document).ready(function() {
            // EMSC - Last 50 earthquakes 200km around Nantes, France
            var url = 'http://www.emsc-csem.org/service/rss/rss.php?typ=emsc&min_lat=43.95411967351&min_long=-5.965270057344&max_lat=50.291525105654&max_long=3.4187817544348';
            url = '../rss.xml';
            initialize();
            handleRSS(url);
        });
    </script>
</html>

